Here’s a first batch of change requests starting at **CR‑301**, framed against the Minimum Viable Stack (FastAPI + TimescaleDB + Neo4j + React/R3F + WebSockets).

I’ll focus on:

- Canonical **message schemas** (data contracts) for telemetry  
- A **pseudo‑API** (REST + WebSocket) that the viewer can build against  

All schemas are directly grounded in the H3LIX / LAIZA spec: Somatic \(\hat s(t)\), Symbolic belief state, Noetic coherence, MPG + Rogue Variables + MUFS, SORK‑N loop.  [oai_citation:0‡Symbiotic_human_AI_architecture.pdf](sediment://file_00000000a2f071f4a36d5a4040b12b83)  

---

## CR‑301 – Canonical H3LIX Telemetry Message Schemas

**Status:** Proposed  
**Type:** Feature / Architecture  
**Baseline:**  
MVP currently assumes “some JSON” streaming from H3LIX to FastAPI / WebSockets. No versioned, shared schema exists.

### 1. Goal

Define **versioned telemetry message contracts** for core runtime events:

- `somatic_state`
- `symbolic_state`
- `noetic_state`
- `decision_cycle`
- `mpg_delta`
- `rogue_variable_event`
- `mufs_event`

These map cleanly onto the Somatic / Symbolic / Noetic layers, Mirror Core SORK‑N loop, and MPG + Rogue Variable + MUFS constructs.  [oai_citation:1‡Symbiotic_human_AI_architecture.pdf](sediment://file_00000000a2f071f4a36d5a4040b12b83)  

### 2. Envelope

All messages share a common envelope, independent of transport (RabbitMQ, Kafka, direct WebSocket).

```ts
interface TelemetryEnvelope<TPayload> {
  v: '1';                         // schema version
  message_type: 
    | 'somatic_state'
    | 'symbolic_state'
    | 'noetic_state'
    | 'decision_cycle'
    | 'mpg_delta'
    | 'rogue_variable_event'
    | 'mufs_event';

  timestamp_utc: string;          // ISO8601, from master clock
  experiment_id: string;
  session_id: string;             // subject × experiment × run
  subject_id: string;             // pseudonymized human id
  run_id?: string;                // optional finer granularity
  sork_cycle_id?: string;         // if tied to one SORK‑N cycle
  decision_id?: string;           // if tied to one decision

  source_layer: 'Somatic' | 'Symbolic' | 'Noetic' | 'MirrorCore' | 'MPG';
  sequence: number;               // monotonic per (session_id, message_type)

  payload: TPayload;
}
```

> **Note:** In Python, we mirror this with Pydantic models; in TS we generate types from the same source spec.

---

### 3. `somatic_state` payload

Somatic layer output is “time‑aligned vectors \(\hat{s}(t)\) with covariance, event‑locked summaries, change‑points/anomaly flags.”  [oai_citation:2‡Symbiotic_human_AI_architecture.pdf](sediment://file_00000000a2f071f4a36d5a4040b12b83)  

```ts
interface SomaticStatePayload {
  t_rel_ms: number;            // ms from session start
  window_ms: number;           // length of feature window

  // Dense vector representation
  features: Record<string, number>;   // e.g. "hrv_sdnn", "pupil_diameter"
  innovation?: Record<string, number>; // ε(t) per channel, if available

  // Optional covariance / uncertainty summaries
  covariance_diag?: Record<string, number>; // per‑feature variance
  global_uncertainty_score?: number;       // 0..1

  // Event markers
  change_point: boolean;        // flagged change‑point
  anomaly_score?: number;       // 0..1 (change‑point detection output)
  anticipatory_markers?: Array<{
    marker_type: 'readiness_like' | 'phase_locking' | 'other';
    lead_time_ms: number;       // ms before predicted event
    confidence: number;         // 0..1
  }>;
}
```

---

### 4. `symbolic_state` payload

Symbolic layer maintains a belief state over entities, events, and relations, and produces predictions + uncertainty.  [oai_citation:3‡Symbiotic_human_AI_architecture.pdf](sediment://file_00000000a2f071f4a36d5a4040b12b83)  

```ts
interface SymbolicStatePayload {
  t_rel_ms: number;

  belief_revision_id: string;

  beliefs: Array<{
    id: string;                       // stable belief/node id
    kind: 'entity' | 'event' | 'relation' | 'policy';
    label: string;                    // short human label
    description?: string;
    valence?: number;                 // -1..1 from m(v)
    intensity?: number;               // 0..1 from m(v)
    recency?: number;                 // 0..1 from m(v)
    stability?: number;               // 0..1 from m(v)
    confidence: number;               // Conf(v) 0..1
    importance: number;               // Imp(v) 0..1
  }>;

  predictions: Array<{
    id: string;
    target_type: 'word' | 'event' | 'outcome';
    horizon_ms?: number;
    topk: Array<{
      value: string;
      probability: number;
    }>;
    brier_score?: number;             // if evaluated
    realized_value?: string;          // if outcome known
    realized_error?: number;          // e.g. abs or squared
  }>;

  uncertainty_regions?: Array<{
    label: string;                    // e.g. "contradictory_self_report"
    belief_ids: string[];
    comment?: string;
  }>;
}
```

---

### 5. `noetic_state` payload

Noetic layer summary: correlation matrices, entropy change, coherence spectra, intuitive accuracy estimates.  [oai_citation:4‡Symbiotic_human_AI_architecture.pdf](sediment://file_00000000a2f071f4a36d5a4040b12b83)  

```ts
interface NoeticStatePayload {
  t_rel_ms: number;
  window_ms: number;

  global_coherence_score: number;      // 0..1, composite
  entropy_change: number;             // ΔH, signed

  // Coarse-grained cross-stream correlations for UI
  stream_correlations: Array<{
    stream_x: 'somatic' | 'symbolic' | 'behavioral' | 'external';
    stream_y: 'somatic' | 'symbolic' | 'behavioral' | 'external';
    r: number;                        // -1..1
  }>;

  // Compressed coherence spectrum for visualization
  coherence_spectrum: Array<{
    band_label: string;               // e.g. "slow", "medium", "fast"
    freq_range_hz: [number, number];
    coherence_strength: number;       // 0..1
  }>;

  intuitive_accuracy_estimate?: {
    p_better_than_baseline: number;   // 0..1 (from scoring rules)
    calibration_error?: number;       // optional metric
  };
}
```

---

### 6. `decision_cycle` payload (SORK‑N loop)

Mirror Core implements S → O → R → K → N → S′.  [oai_citation:5‡Symbiotic_human_AI_architecture.pdf](sediment://file_00000000a2f071f4a36d5a4040b12b83)  

```ts
interface DecisionCyclePayload {
  sork_cycle_id: string;
  decision_id?: string;

  phase: 'S' | 'O' | 'R' | 'K' | 'N' | 'S_prime';
  phase_started_utc: string;
  phase_ended_utc?: string;

  // Lightweight references into other streams / MPG
  stimulus_refs?: Array<{ channel: string; ref_id: string }>;
  organism_belief_ids?: string[];
  response_action?: {
    action_id: string;
    label: string;
    params?: Record<string, unknown>;
  };
  consequence_outcome?: {
    label: string;
    metrics: Record<string, number>;  // reward, accuracy, latency, etc.
  };
  noetic_adjustments?: {
    attention_gain?: number;
    decision_threshold_delta?: number;
    learning_rate_delta?: number;
  };
}
```

This lets the UI draw the glowing SORK‑N ring and show phase‑linked events.

---

### 7. `mpg_delta` payload

This is the workhorse for the MPG “cognitive city.” It encodes **incremental updates** to the Layer‑Type Graph hierarchy described in Section 4.1 and visualized in the MPG diagrams on pages 10–12 (nodes, segments, lift operator).  [oai_citation:6‡Symbiotic_human_AI_architecture.pdf](sediment://file_00000000a2f071f4a36d5a4040b12b83)  

```ts
interface MpgDeltaPayload {
  mpg_id: string;             // profile id (per subject)
  level: number;              // k in G^(k)
  delta_id: string;           // for replay/versioning

  operations: Array<
    | { kind: 'add_node'; node: MpgNode }
    | { kind: 'update_node'; node_id: string; patch: Partial<MpgNode> }
    | { kind: 'add_edge'; edge: MpgEdge }
    | { kind: 'update_edge'; edge_id: string; patch: Partial<MpgEdge> }
    | { kind: 'add_segment'; segment: MpgSegment }
    | { kind: 'update_segment'; segment_id: string; patch: Partial<MpgSegment> }
  >;
}

interface MpgNode {
  id: string;
  label: string;
  description?: string;

  layer_tags: string[];          // e.g. ["Psychological", "Family"]
  metrics: {
    valence: number;             // -1..1 (m)
    intensity: number;           // 0..1
    recency: number;             // 0..1
    stability: number;           // 0..1
  };
  confidence: number;            // Conf(v)
  importance: number;            // Imp(v)
  roles?: string[];              // e.g. ["hub", "bridge"]

  // optional short evidence preview for UI hover
  evidence_preview?: Array<{
    evidence_id: string;
    snippet: string;
    source_class: string;
    timestamp_utc: string;
  }>;

  reasoning_provenance?: string; // R(v)
}

interface MpgEdge {
  id: string;
  source: string;
  target: string;
  type: string;                  // τ(e) e.g. "causes", "buffers"
  strength: number;              // w(e) 0..1
  confidence: number;            // Conf(e)
}

interface MpgSegment {
  id: string;
  label: string;
  level: number;                 // must equal payload.level
  member_node_ids: string[];

  cohesion: number;              // 0..1
  average_importance: number;    // from Imp
  average_confidence: number;    // from Conf
  affective_load?: number;       // rolled up valence/intensity
}
```

---

### 8. `rogue_variable_event` payload

Rogue Variables are segments or pathways whose Shapley contributions exceed a 3‑sigma band.  [oai_citation:7‡Symbiotic_human_AI_architecture.pdf](sediment://file_00000000a2f071f4a36d5a4040b12b83)  

```ts
interface RogueVariableEventPayload {
  rogue_id: string;
  mpg_id: string;

  candidate_type: 'segment' | 'pathway';
  level_range: [number, number];   // e.g. [0, 2]
  segment_ids?: string[];
  pathway_nodes?: string[];        // ordered node ids for route

  shapley_stats: {
    mean_abs_contrib: number;      // s̄(x)
    std_abs_contrib: number;       // σ̂(x)
    candidate_abs_contrib: number; // s_k(x)
    z_score: number;               // (s_k - mean) / std
  };

  potency_index: number;           // composite impact score
  impact_factors: {
    rate_of_change: number;        // 0..1
    breadth_of_impact: number;     // 0..1
    amplification: number;         // 0..1
    emotional_load: number;        // 0..1
    gate_leverage: number;         // 0..1
    robustness: number;            // 0..1
  };
}
```

---

### 9. `mufs_event` payload

Minimal Unaware Flip Sets (MUFS) define MPG‑Intuition: a nonempty set of unaware elements whose removal flips a decision.  [oai_citation:8‡Symbiotic_human_AI_architecture.pdf](sediment://file_00000000a2f071f4a36d5a4040b12b83)  

```ts
interface MufsEventPayload {
  mufs_id: string;
  decision_id: string;
  mpg_id: string;

  unawareness_types: Array<'IU' | 'PU'>; // Input / Process unawareness
  input_unaware_refs?: string[];         // observation ids (O \ Õ)
  process_unaware_node_ids?: string[];   // nodes/segments in U_proc

  // What changes when U is removed
  decision_full: {
    choice: string;                      // e.g. class label
    utility: Record<string, number>;     // R(H)
  };
  decision_without_U: {
    choice: string;
    utility: Record<string, number>;
  };

  minimal: boolean;                      // verified MUFS (true/false)
  search_metadata?: {
    search_method: 'exact' | 'heuristic';
    candidates_checked: number;
  };
}
```

---

### 10. Acceptance criteria

- H3LIX core emits all runtime telemetry wrapped in `TelemetryEnvelope` with payload types above.
- FastAPI backend validates them with Pydantic models.
- TypeScript types for the viewer are generated from the same schema (e.g. via JSON Schema → TS).
- At least one end‑to‑end path (`somatic_state`, `mpg_delta`) is wired through to the browser and visualized in a trivial way (e.g. raw log panel) to validate contracts.

---

## CR‑302 – Visualization‑Facing API (Snapshot, Stream, Replay & Query)

**Status:** Proposed  
**Type:** Feature / API  
**Baseline:**  
MVP has a FastAPI service and raw WebSockets but no clear REST / stream contract for the 3D viewer.

### 1. Goal

Expose a **minimal but complete API** for:

1. **Discovering sessions**
2. Getting the **current snapshot** (for initial load of the 3D brain)
3. **Streaming** live telemetry
4. **Replaying** historical windows
5. Querying **MPG subgraphs** and **decision traces**

All payloads reuse the message contracts from CR‑301.

---

### 2. REST API – Sessions & Snapshots

#### 2.1 `GET /v1/sessions`

List sessions available for visualization.

```http
GET /v1/sessions
```

**Response (200):**

```json
[
  {
    "session_id": "sess_2025_03_01_001",
    "experiment_id": "exp_intuition_task_a",
    "subject_id": "subj_007",
    "status": "active",            // "active" | "completed"
    "started_utc": "2025-03-01T10:00:00Z",
    "ended_utc": null
  }
]
```

---

#### 2.2 `GET /v1/sessions/{session_id}/snapshot`

Return a “now” view: latest Somatic, Symbolic, Noetic state, plus a compact MPG slice and last decision cycle. This drives the initial triple‑helix + city view.

```http
GET /v1/sessions/{session_id}/snapshot?t_rel_ms=123456   # optional time cursor
```

**Response (200):**

```ts
interface SnapshotResponse {
  session_id: string;
  t_rel_ms: number;

  somatic: SomaticStatePayload;
  symbolic: SymbolicStatePayload;
  noetic: NoeticStatePayload;

  last_decision_cycle?: DecisionCyclePayload;

  mpg: {
    mpg_id: string;
    level_summaries: Array<{
      level: number;
      node_count: number;
      segment_count: number;
    }>;
    // default “city” around most important nodes at base level
    base_subgraph: {
      level: number;
      nodes: MpgNode[];
      edges: MpgEdge[];
      segments: MpgSegment[];
    };
  };
}
```

---

### 3. REST API – MPG & Decision Queries

#### 3.1 `GET /v1/sessions/{session_id}/mpg/{level}/subgraph`

Fetch a localized MPG subgraph for the “city” view, e.g. around a Rogue Variable segment highlighted in the paper’s MPG examples.  [oai_citation:9‡Symbiotic_human_AI_architecture.pdf](sediment://file_00000000a2f071f4a36d5a4040b12b83)  

```http
GET /v1/sessions/{session_id}/mpg/{level}/subgraph
  ?center_node_id=node_123
  &radius=2
  &max_nodes=500
```

**Response (200):**

```ts
interface MpgSubgraphResponse {
  mpg_id: string;
  level: number;
  center_node_id?: string;
  nodes: MpgNode[];
  edges: MpgEdge[];
  segments: MpgSegment[];
}
```

---

#### 3.2 `GET /v1/sessions/{session_id}/decisions/{decision_id}`

Return a full decision trace across SORK‑N, linked to MUFS and Rogue Variables (for the side‑by‑side “flip city” visualization).  [oai_citation:10‡Symbiotic_human_AI_architecture.pdf](sediment://file_00000000a2f071f4a36d5a4040b12b83)  

```http
GET /v1/sessions/{session_id}/decisions/{decision_id}
```

**Response (200):**

```ts
interface DecisionTraceResponse {
  session_id: string;
  decision_id: string;

  phases: DecisionCyclePayload[];          // ordered S→O→R→K→N→S'

  mufs_events?: MufsEventPayload[];
  rogue_variable_events?: RogueVariableEventPayload[];

  // Optional MPG snapshots for “full vs restricted” comparison
  mpg_full?: MpgSubgraphResponse;
  mpg_without_mufs?: MpgSubgraphResponse;
}
```

---

### 4. REST API – Replay

#### 4.1 `GET /v1/sessions/{session_id}/replay`

Fetch a chunk of telemetry for scrubbing the time slider around a specific event.

```http
GET /v1/sessions/{session_id}/replay
  ?from_ms=120000
  &to_ms=180000
  &message_types=somatic_state,symbolic_state,noetic_state,mpg_delta
  &max_messages=5000
```

**Response (200):**

```ts
interface ReplayResponse {
  session_id: string;
  from_ms: number;
  to_ms: number;
  messages: Array<TelemetryEnvelope<any>>;
}
```

> The viewer replays these with client‑side interpolation to animate the helix and city.

---

### 5. WebSocket API – Live Stream

#### 5.1 `GET /v1/stream`

Single WebSocket endpoint with **subscribe message** from client.

```http
GET /v1/stream
Sec-WebSocket-Protocol: json_v1
```

Once connected, client sends:

```json
{
  "type": "subscribe",
  "session_id": "sess_2025_03_01_001",
  "message_types": [
    "somatic_state",
    "symbolic_state",
    "noetic_state",
    "decision_cycle",
    "mpg_delta",
    "rogue_variable_event",
    "mufs_event"
  ]
}
```

Server responds with:

```json
{ "type": "ack", "subscription_id": "sub_abc123" }
```

Then streams frames:

```json
{
  "type": "event",
  "subscription_id": "sub_abc123",
  "data": {
    "v": "1",
    "message_type": "somatic_state",
    "timestamp_utc": "2025-03-01T10:05:00.123Z",
    "experiment_id": "exp_intuition_task_a",
    "session_id": "sess_2025_03_01_001",
    "subject_id": "subj_007",
    "source_layer": "Somatic",
    "sequence": 1023,
    "payload": { /* SomaticStatePayload */ }
  }
}
```

Clients may later send:

```json
{ "type": "unsubscribe", "subscription_id": "sub_abc123" }
```

---

### 6. Storage Mapping (high‑level)

- **TimescaleDB**  
  - Tables: `somatic_state`, `symbolic_state`, `noetic_state`, `decision_cycle`, with `session_id`, `t_rel_ms` as primary time key and a `payload` JSONB column.

- **Neo4j**  
  - MPG persisted as nodes/edges/segments keyed by `mpg_id`, `level`, and node/edge IDs from `MpgNode` / `MpgEdge` / `MpgSegment`.  
  - `mpg_delta` messages become append‑only log entries + upserts to the graph.

This keeps the API stable while we tune internal layout and performance.

---

### 7. Acceptance criteria

- Front‑end can:
  - List sessions.
  - Load `/snapshot` and render a static helix + MPG city.
  - Connect to `/v1/stream` and update visualization in real time using CR‑301 message types.
  - Scrub a time window with `/replay`.
- Back‑end logs and validates all live messages against the shared schema; invalid payloads are rejected with clear errors.

---

If you’d like, I can follow this up with a **CR‑303** that defines concrete TypeScript/Pydantic model modules and a tiny example client (e.g. how the React app wires `/snapshot` + `/stream` into R3F state) using these contracts.
